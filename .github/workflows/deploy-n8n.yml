name: Deploy N8N to Nomad

on:
  push:
    branches:
      - main
    paths:
      - 'jobs/n8n.nomad.hcl'
      - '.github/workflows/deploy-n8n.yml'

jobs:
  deploy:
    name: Redeploy N8N on Job File Change
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Validate Nomad Job File
        run: |
          if [ ! -f "jobs/n8n.nomad.hcl" ]; then
            echo "‚ùå Error: jobs/n8n.nomad.hcl not found"
            exit 1
          fi
          echo "‚úì Job file found and validation passed"

      - name: Deploy N8N to Nomad
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 10m
          script: |
            set -e
            
            echo "üìã Pulling latest changes from repository..."
            cd /opt/nomad/jobs
            git pull origin main
            
            echo "üîç Validating job file..."
            nomad job validate /opt/nomad/jobs/n8n.nomad.hcl
            
            echo "üìù Planning deployment..."
            nomad job plan /opt/nomad/jobs/n8n.nomad.hcl
            
            echo "üöÄ Deploying N8N job..."
            nomad job run /opt/nomad/jobs/n8n.nomad.hcl
            
            echo "‚è≥ Waiting for allocation..."
            sleep 5
            
            echo "‚úÖ Checking deployment status..."
            nomad status n8n
            
            echo "‚úì N8N deployment completed successfully"

      - name: Verify N8N Health
        run: |
          echo "üè• Checking N8N health..."
          for i in {1..30}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -k https://${{ secrets.HOST }} || echo "000")
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "401" ]; then
              echo "‚úì N8N is healthy (HTTP $HTTP_CODE)"
              exit 0
            fi
            echo "Attempt $i/30: HTTP $HTTP_CODE - waiting..."
            sleep 10
          done
          echo "‚ö†Ô∏è N8N health check timeout (may still be starting)"

      - name: Notify Success
        if: success()
        run: |
          echo "‚úÖ N8N deployment successful!"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"

      - name: Notify Failure
        if: failure()
        run: |
          echo "‚ùå N8N deployment failed!"
          echo "Check logs above for details"
          exit 1